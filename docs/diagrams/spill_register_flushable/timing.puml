@startuml spill_register_flushable_timing
!theme plain
skinparam backgroundColor #FFFFFF
skinparam shadowing false

title Spill Register Flushable Timing Diagram\nShowing Flush Operation

concise "clk_i" as clk
robust "valid_i" as valid_i
robust "ready_i" as ready_i
robust "flush_i" as flush_i
robust "data_i" as data_i
concise "ready_o" as ready_o
robust "valid_o" as valid_o
robust "data_o" as data_o
robust "a_full_q" as a_full
robust "b_full_q" as b_full
robust "State" as state

@0
clk is 0
valid_i is 1
ready_i is 0
flush_i is 0
data_i is "A"
ready_o is 1
valid_o is 0
data_o is "-"
a_full is 0
b_full is 0
state is "EMPTY"

' Cycle 1: Data A enters
@100
clk is 1
@200
clk is 0

' Cycle 2: A full, B gets data, C enters A
@300
clk is 1
@320
a_full is 1
valid_o is 1
data_o is "A"
state is "A_ONLY"
@350
data_i is "B"
@400
clk is 0

' Cycle 3: Both full
@500
clk is 1
@520
b_full is 1
a_full is 1
data_o is "A"
state is "BOTH_FULL"
ready_o is 0
@550
data_i is "C"
@600
clk is 0

note bottom of state : Both registers full\nBackpressure active (ready_o=0)

' Cycle 4: Flush triggered!
@700
clk is 1
@720
flush_i is 1
@800
clk is 0

note bottom of state : Flush signal asserted!

' Cycle 5: Registers cleared
@900
clk is 1
@920
flush_i is 0
a_full is 0
b_full is 0
valid_o is 0
data_o is "-"
ready_o is 1
state is "EMPTY"
@950
valid_i is 1
data_i is "D"

@1000
clk is 0

note bottom of state : Flush complete: Both registers cleared\nready_o=1, valid_o=0

' Cycle 6: New data D enters
@1100
clk is 1
@1200
clk is 0

' Cycle 7: D visible
@1300
clk is 1
@1320
a_full is 1
valid_o is 1
data_o is "D"
state is "A_ONLY"
@1350
ready_i is 1
@1400
clk is 0

note bottom of state : Normal operation resumed\nData D at output

' Cycle 8: D consumed
@1500
clk is 1
@1520
a_full is 0
valid_o is 0
data_o is "-"
state is "EMPTY"
@1550
valid_i is 0
@1600
clk is 0

@1700

highlight 100 to 600 #C8E6C9 : Normal Fill Operation
highlight 700 to 800 #FF6B6B : Flush Triggered
highlight 900 to 1000 #E1F5FE : Registers Cleared
highlight 1100 to 1600 #E8F5E9 : Normal Operation Resumed

legend bottom
    <b>Flush Operation:</b>
    • Cycle 4: flush_i asserted while both registers full
    • Cycle 5: Both a_full_q and b_full_q cleared to 0
    • Pipeline emptied immediately
    • ready_o goes high, valid_o goes low
    • New data can be accepted starting cycle 6
    
    <b>Critical Timing:</b>
    • Flush takes effect on next rising clock edge
    • a_drain and b_drain both forced to 1 by flush_i
    • a_fill and b_fill blocked while flush_i=1
    
    <b>Assertion:</b>
    flush_i and valid_i must NOT be high simultaneously
    (would cause data loss)
end legend

@enduml
