@startuml spill_register_flushable_timing
!theme plain
skinparam backgroundColor #FFFFFF
skinparam shadowing false

title Spill Register Flushable Timing Diagram\nShowing Flush Operation

concise "clk_i" as clk
robust "valid_i" as valid_i
robust "ready_i" as ready_i
robust "flush_i" as flush_i
robust "data_i" as data_i
concise "ready_o" as ready_o
robust "valid_o" as valid_o
robust "data_o" as data_o
robust "a_full_q" as a_full
robust "b_full_q" as b_full
robust "State" as state

@0
clk is 0
valid_i is 1
ready_i is 0
flush_i is 0
data_i is "A"
ready_o is 1
valid_o is 0
data_o is "-"
a_full is 0
b_full is 0
state is "EMPTY"

@25
clk is 1
@50
clk is 0

@75
clk is 1
@80
a_full is 1
valid_o is 1
data_o is "A"
state is "A_ONLY"
@87
data_i is "B"
@100
clk is 0

@125
clk is 1
@130
b_full is 1
a_full is 1
data_o is "A"
state is "BOTH_FULL"
ready_o is 0
@137
data_i is "C"
@150
clk is 0

note bottom of state : Both full

@175
clk is 1
@180
flush_i is 1
@200
clk is 0

note bottom of state : Flush!

@225
clk is 1
@230
flush_i is 0
a_full is 0
b_full is 0
valid_o is 0
data_o is "-"
ready_o is 1
state is "EMPTY"
@237
valid_i is 1
data_i is "D"

@250
clk is 0

note bottom of state : Cleared

@275
clk is 1
@300
clk is 0

@325
clk is 1
@330
a_full is 1
valid_o is 1
data_o is "D"
state is "A_ONLY"
@337
ready_i is 1
@350
clk is 0

note bottom of state : Resumed

@375
clk is 1
@380
a_full is 0
valid_o is 0
data_o is "-"
state is "EMPTY"
@387
valid_i is 0
@400
clk is 0

@425

highlight 25 to 150 #C8E6C9 : Normal Fill
highlight 175 to 200 #FF6B6B : Flush
highlight 225 to 250 #E1F5FE : Cleared
highlight 275 to 400 #E8F5E9 : Resumed

legend bottom
    <b>Flush Operation:</b>
    - Cycle 4: flush_i asserted while both registers full
    - Cycle 5: Both a_full_q and b_full_q cleared to 0
    - Pipeline emptied immediately
    - ready_o goes high, valid_o goes low
    - New data can be accepted starting cycle 6
    
    <b>Critical Timing:</b>
    - Flush takes effect on next rising clock edge
    - a_drain and b_drain both forced to 1 by flush_i
    - a_fill and b_fill blocked while flush_i=1
    
    <b>Assertion:</b>
    flush_i and valid_i must NOT be high simultaneously
    (would cause data loss)
end legend

@enduml
