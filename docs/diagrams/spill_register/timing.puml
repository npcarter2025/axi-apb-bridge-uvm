@startuml spill_register_timing
!theme plain
skinparam backgroundColor #FFFFFF
skinparam shadowing false

title Spill Register Timing Diagram\nShowing Always-Present Latency and Two-Register Buffering

concise "clk_i" as clk
robust "valid_i" as valid_i
robust "ready_i" as ready_i
robust "data_i" as data_i
concise "ready_o" as ready_o
robust "valid_o" as valid_o
robust "data_o" as data_o
robust "a_full_q" as a_full
robust "b_full_q" as b_full
robust "a_data_q" as a_data
robust "b_data_q" as b_data
robust "State" as state

@0
clk is 0
valid_i is 0
ready_i is 1
data_i is "-"
ready_o is 1
valid_o is 0
data_o is "-"
a_full is 0
b_full is 0
a_data is "-"
b_data is "-"
state is "EMPTY"

@25
clk is 1
@37
valid_i is 1
data_i is "A"

@50
clk is 0

@75
clk is 1
@80
a_full is 1
a_data is "A"
valid_o is 1
data_o is "A"
state is "A_ONLY"
@87
data_i is "B"

@100
clk is 0

@125
clk is 1
@130
ready_i is 0
@137
data_i is "C"
b_full is 1
b_data is "A"
a_data is "B"
state is "BOTH_FULL"

@150
clk is 0

@175
clk is 1
@180
ready_o is 0
@187
data_i is "D"

@200
clk is 0

@225
clk is 1
@230
ready_i is 1
@237
b_full is 0
data_o is "B"
ready_o is 1
state is "A_ONLY"

@250
clk is 0

@275
clk is 1
@280
valid_i is 1
data_i is "D"
@287
a_data is "D"
data_o is "C"

@300
clk is 0

@325
clk is 1
@337
data_o is "D"

@350
clk is 0

@375
clk is 1
@380
valid_i is 0

@400
clk is 0

@425
clk is 1
@430
a_full is 0
valid_o is 0
data_o is "-"
state is "EMPTY"

@450

highlight 25 to 50 #E1F5FE : Data Entry
highlight 75 to 100 #C8E6C9 : 1 Cycle Latency
highlight 125 to 150 #FFE0B2 : Both Filling
highlight 175 to 200 #FFCDD2 : Backpressure
highlight 225 to 250 #E8F5E9 : B Drains
highlight 275 to 300 #C8E6C9 : A Drains

legend bottom
    <b>Key Observations:</b>
    • Minimum 1 cycle latency: Data A enters cycle 1, appears cycle 2
    • Two-register buffering: Can hold 2 items (cycles 3-4)
    • Backpressure at cycle 4: ready_o=0 when both registers full
    • Data priority: B drains before A (older data first)
    • All paths registered: No combinational paths
    • Sustained throughput: Can accept new data while draining old
    
    <b>Compare to Fall-Through Register:</b>
    Fall-through can have zero latency, but spill register always ≥1 cycle
end legend

@enduml
